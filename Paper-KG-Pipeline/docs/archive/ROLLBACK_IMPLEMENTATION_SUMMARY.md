# Rollback Mechanism - å®ç°æ€»ç»“

## æ ¸å¿ƒéœ€æ±‚

âœ… **å·²å®Œæˆ**ï¼šå½“æ³¨å…¥æŸç±» patternï¼ˆæ¯”å¦‚æ–°é¢–æ€§ï¼‰åè€Œè®©å®ƒåœ¨ä¸‹ä¸€è½®çš„è¿™ä¸ªç»´åº¦æ‰“åˆ†æ›´ä½æ—¶ï¼Œç³»ç»Ÿä¼šï¼š
1. èˆå¼ƒä¹‹å‰çš„å˜æ›´ï¼Œå›åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
2. æ ‡è®°è¯¥ pattern åœ¨è¯¥ issue ä¸Šå¤±è´¥
3. æŒ‰ç…§é¡ºåºé‡æ–°é€‰æ‹©æ–°çš„ pattern å°è¯•

## å®ç°èŒƒå›´

### æ–‡ä»¶ä¿®æ”¹

#### 1. `/scripts/pipeline/manager.py` - ä¸»æµç¨‹ç®¡ç†
**æ·»åŠ å†…å®¹**ï¼š
- `last_story_before_refinement` - ä¿å­˜å›æ»šç‚¹
- `last_issue_type` - è¿½è¸ªä¸Šä¸€è½®çš„è¯Šæ–­é—®é¢˜ç±»å‹
- `pattern_failure_map` - è®°å½•å¤±è´¥çš„ pattern-issue ç»„åˆ
- åˆ†æ•°é€€åŒ–æ£€æµ‹é€»è¾‘ï¼ˆ97-135 è¡Œï¼‰
- å›æ»šæ‰§è¡Œæµç¨‹ï¼ˆ6 ä¸ªæ­¥éª¤ï¼‰
- Refinement history è®°å½• pattern_id

**å…³é”®é€»è¾‘**ï¼š
```python
if curr_issue_score < prev_issue_score - 0.1:
    # 6 æ­¥å›æ»šæµç¨‹
    1. æ¢å¤ Story
    2. æ ‡è®° Pattern å¤±è´¥
    3. ç§»é™¤ä¿®æ­£è®°å½•
    4. æ¢å¤ Tricks
    5. é€šçŸ¥ RefinementEngine
    6. ç»§ç»­ä¸‹ä¸€è½®è¿­ä»£
```

#### 2. `/scripts/pipeline/refinement.py` - ä¿®æ­£å¼•æ“
**æ·»åŠ å†…å®¹**ï¼š
- `self.current_pattern_id` - è®°å½•å½“å‰ä½¿ç”¨çš„ pattern
- `self.pattern_failure_map` - å¼•æ“çº§åˆ«çš„æ•…éšœæ˜ å°„
- `_is_pattern_failed_for_issue()` - æ£€æŸ¥å¤±è´¥çŠ¶æ€
- `mark_pattern_failed()` - æ ‡è®°å¤±è´¥
- åœ¨ `_select_pattern_for_fusion()` å’Œ `_inject_tail_tricks()` ä¸­æ·»åŠ è·³è¿‡å¤±è´¥ pattern çš„é€»è¾‘

**å…³é”®åŠŸèƒ½**ï¼š
```python
# é€‰æ‹© pattern æ—¶è‡ªåŠ¨è·³è¿‡å¤±è´¥çš„
if self._is_pattern_failed_for_issue(pattern_id, issue_type):
    print(f"â­ï¸  è·³è¿‡å·²å¤±è´¥çš„ {pattern_id}")
    continue

# æ ‡è®°å¤±è´¥ä»¥ä¾›åç»­æŸ¥è¯¢
self.mark_pattern_failed(pattern_id, issue_type)
```

### æ–°å¢æ–‡æ¡£

1. `ROLLBACK_MECHANISM.md` - è¯¦ç»†çš„æŠ€æœ¯è®¾è®¡æ–‡æ¡£
2. `ROLLBACK_EXAMPLE.md` - å®é™…è¿è¡Œç¤ºä¾‹å’Œè°ƒè¯•æŒ‡å—
3. `ROLLBACK_IMPLEMENTATION_SUMMARY.md` - æœ¬æ–‡æ¡£

## å·¥ä½œæµç¨‹

### è¿­ä»£æµç¨‹å›¾

```
è¯„å®¡ Story
   â†“
[æ£€æµ‹åˆ†æ•°å˜åŒ–]
   â”œâ”€ åˆ†æ•°ä¸Šå‡ â†’ ç»§ç»­ âœ“
   â”œâ”€ åˆ†æ•°ä¸å˜ â†’ ç»§ç»­ âœ“
   â””â”€ åˆ†æ•°ä¸‹é™ â†“

ã€ROLLBACK TRIGGEREDã€‘
   â†“
[6 æ­¥å›æ»š]
   1. æ¢å¤ Story
   2. æ ‡è®° Pattern å¤±è´¥
   3. ç§»é™¤è®°å½•
   4. æ¢å¤ Tricks
   5. é€šçŸ¥å¼•æ“
   6. ç»§ç»­è¿­ä»£
   â†“
é€‰æ‹©æ–° Pattern
   â”œâ”€ å¦‚æœå­˜åœ¨æœªå¤±è´¥çš„ pattern â†’ é€‰æ‹©å®ƒ âœ“
   â””â”€ å¦‚æœå…¨éƒ¨å¤±è´¥ â†’ é™çº§åˆ°ä¼ ç»Ÿ trick æ³¨å…¥
   â†“
é‡æ–°ç”Ÿæˆ Story å°è¯•æ”¹è¿›
```

## å›æ»šæ£€æµ‹é€»è¾‘

### åˆ†æ•°å¯¹æ¯”

```python
# ä¸Šä¸€è½®çš„è¯„åˆ†
prev_issue_score = review_history[-1]['reviews']['Novelty']['score']  # ä¾‹å¦‚ 6.2

# æœ¬è½®çš„è¯„åˆ†
curr_issue_score = critic_result['reviews']['Novelty']['score']        # ä¾‹å¦‚ 5.9

# è§¦å‘æ¡ä»¶
if curr_issue_score < prev_issue_score - 0.1:  # 5.9 < 6.2 - 0.1
    # å›æ»šï¼
```

### æ•…éšœæ˜ å°„ç¤ºä¾‹

```python
pattern_failure_map = {
    'pattern_106': {'novelty'},        # å¯¹ novelty å¤±è´¥
    'pattern_73': {'novelty', 'stability'},  # å¯¹ä¸¤ä¸ªéƒ½å¤±è´¥
    'pattern_107': {'novelty'},        # å¯¹ novelty å¤±è´¥
}
```

## å…³é”®è®¾è®¡å†³ç­–

### 1. æµ®åŠ¨è¯¯å·®å®¹é™
- **è®¾ç½®ä¸º 0.1** åˆ†
- **åŸå› **ï¼šå…è®¸æ­£å¸¸çš„åˆ†æ•°æ³¢åŠ¨ï¼Œé¿å…è¿‡åº¦æ•æ„Ÿ
- **å¯è°ƒ**ï¼šæ ¹æ®éœ€è¦æ”¹ä¸º 0.05ï¼ˆæ›´æ¿€è¿›ï¼‰æˆ– 0.2ï¼ˆæ›´å®½æ¾ï¼‰

### 2. æ•…éšœç²’åº¦
- **ç²’åº¦**ï¼špattern-level å’Œ issue-level çš„äºŒç»´æ˜ å°„
- **ä¼˜åŠ¿**ï¼šåŒä¸€ä¸ª pattern å¯¹ä¸åŒ issue å¯æœ‰ä¸åŒæ•ˆæœ
- **ä¾‹å¦‚**ï¼špattern_73 å¯èƒ½å¯¹ novelty æ— æ•ˆä½†å¯¹ stability æœ‰æ•ˆ

### 3. å›æ»šèŒƒå›´
- **å›æ»šå†…å®¹**ï¼šStory + Tricks + Refinement è®°å½•
- **ä¸å›æ»š**ï¼šReview historyï¼ˆä¿ç•™ä»¥ä¾›åç»­å¯¹æ¯”ï¼‰
- **ç†ç”±**ï¼šéœ€è¦ä¿ç•™åˆ†æ•°å†å²æ¥æ£€æµ‹è¶‹åŠ¿

### 4. ç»§ç»­ç­–ç•¥
- **åœ¨å›æ»šåè‡ªåŠ¨ç»§ç»­**ï¼šä½¿ç”¨ `continue` è·³è¿‡æœ¬è½®è¯„å®¡è®°å½•æ›´æ–°
- **è‡ªåŠ¨é€‰æ‹©æ–° pattern**ï¼šä¸‹ä¸€è½®è¿­ä»£ä¼šè‡ªåŠ¨è°ƒç”¨ `_select_pattern_for_fusion()`
- **æ•ˆæœ**ï¼šç”¨æˆ·å®Œå…¨æ— æ„Ÿï¼Œç³»ç»Ÿè‡ªåŠ¨çº æ­£

## é›†æˆç‚¹

### ä¸ Idea Fusion çš„é›†æˆ
```
Refinement.refine_with_idea_fusion()
   â†“
é€‰æ‹© Patternï¼ˆè·³è¿‡å·²å¤±è´¥ï¼‰â† ã€å›æ»šæœºåˆ¶ã€‘
   â†“
IdeaFusionEngine.fuse()
   â†“
è¿”å›èåˆåçš„ idea
   â†“
StoryGenerator.generate()
   â†“
LLM ç”Ÿæˆæ–° Story
   â†“
MultiAgentCritic.review()
   â†“
ã€æ£€æµ‹åˆ†æ•°ã€‘â† ã€å›æ»šæœºåˆ¶ã€‘
```

### ä¸ Pattern Selection çš„é›†æˆ
- RefinementEngine ç»´æŠ¤ `pattern_failure_map`
- Manager ç»´æŠ¤æœ¬åœ° `pattern_failure_map`ï¼ˆå¤‡ä»½ï¼‰
- ä¸¤è€…é€šè¿‡ `mark_pattern_failed()` ä¿æŒåŒæ­¥

## æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šå•æ¬¡å›æ»š
```
Iter 1: novelty = 5.5
Iter 2: novelty = 6.2 âœ“
Iter 3: novelty = 5.9 âŒ â†’ å›æ»š
Iter 3: novelty = 6.4 âœ“ (æ–° pattern)
```

### åœºæ™¯ 2ï¼šè¿ç»­å›æ»šï¼ˆæŒ‡ç¤ºé—®é¢˜ï¼‰
```
Iter 1: novelty = 5.5
Iter 2: novelty = 6.2 âœ“
Iter 3: novelty = 5.9 âŒ â†’ å›æ»š
Iter 3: novelty = 5.8 âŒ â†’ å†æ¬¡å›æ»š
Iter 3: novelty = 5.7 âŒ â†’ å†æ¬¡å›æ»š
â†’ åœæ­¢å°è¯•ï¼Œé™çº§å¤„ç†
```

### åœºæ™¯ 3ï¼šå¤šç»´åº¦å¤±è´¥
```
Pattern A: å¯¹ novelty å¤±è´¥ â†’ è®°å½•
Pattern B: å¯¹ stability å¤±è´¥ â†’ è®°å½•
Pattern C: å¯¹ä¸¤ä¸ªéƒ½å¤±è´¥ â†’ è®°å½•

æœªæ¥é€‰æ‹©æ—¶ä¼šè·³è¿‡è¿™äº›ç»„åˆ
```

## ç›‘æ§å’Œè°ƒè¯•

### æ—¥å¿—æ ‡è¯†
```
ã€ROLLBACK TRIGGEREDã€‘ - å›æ»šè§¦å‘
   âœ… Step 1-5     - å„æ­¥éª¤æ‰§è¡Œ
   â­ï¸  è·³è¿‡å·²å¤±è´¥çš„   - Pattern è·³è¿‡
   ğŸ“ è®°å½•å¤±è´¥æ˜ å°„   - æ•…éšœè®°å½•
```

### ç»Ÿè®¡æ•°æ®
- å›æ»šæ¬¡æ•°
- å¹³å‡æ¯æ¬¡è¿­ä»£çš„å›æ»šæ¦‚ç‡
- æœ€å¸¸å¤±è´¥çš„ pattern-issue ç»„åˆ
- Pattern æˆåŠŸç‡

## æ€§èƒ½å½±å“

### æ­£é¢
- âœ… å‡å°‘æ— æ•ˆè¿­ä»£ï¼ˆé€šè¿‡è‡ªåŠ¨çº æ­£ï¼‰
- âœ… æ›´å¿«æ”¶æ•›åˆ°é«˜è´¨é‡ story
- âœ… æ€»ä½“ LLM è°ƒç”¨æ•°å¯èƒ½å‡å°‘

### ä¸­æ€§
- â– å›æ»šæ“ä½œæœ¬èº«å¼€é”€æå°
- â– å†…å­˜å ç”¨å¢åŠ ä¸æ˜¾è‘—ï¼ˆåªæ˜¯å­—å…¸ï¼‰

### éœ€è¦ç›‘æ§
- å›æ»šé¢‘ç‡æ˜¯å¦è¿‡é«˜ï¼ˆå¯èƒ½æŒ‡ç¤ºé—®é¢˜ï¼‰
- æ˜¯å¦å­˜åœ¨å¾ªç¯å›æ»šï¼ˆéœ€è¦é™çº§ï¼‰

## æ‰©å±•æ–¹å‘

### 1. åŠ æƒè¯„åˆ†
```python
# ç›®å‰ï¼šéƒ½æ˜¯ -0.1
# æœªæ¥ï¼šå¯æ ¹æ®é‡è¦æ€§åŠ æƒ
novelty_weight = 1.5
if curr_score < prev_score - (0.1 * novelty_weight):
    rollback()
```

### 2. æœºå™¨å­¦ä¹ 
```python
# å­¦ä¹  pattern å¯¹å„ä¸ª issue çš„æ•ˆæœæ¦‚ç‡
pattern_effectiveness = {
    'pattern_106': {'novelty': 0.8, 'stability': 0.3},
    'pattern_73': {'novelty': 0.2, 'stability': 0.9},
}
# ä¼˜å…ˆé€‰æ‹©é¢„æœŸæ•ˆæœå¥½çš„ç»„åˆ
```

### 3. ç”¨æˆ·åé¦ˆ
```python
# å…è®¸ç”¨æˆ·æŒ‡å®šå“ªäº› pattern ä¸åº”è¯¥å°è¯•
user_blocked_patterns = ['pattern_73']
# ç³»ç»Ÿä¼šè‡ªåŠ¨è·³è¿‡
```

## æ€»ç»“

âœ… **å®Œæ•´å®ç°äº†**ç”¨æˆ·æå‡ºçš„éœ€æ±‚ï¼š
- æ£€æµ‹è¯„åˆ†ä¸‹é™
- è‡ªåŠ¨å›æ»šåˆ°å‰ä¸€ä¸ªç‰ˆæœ¬
- æ ‡è®°å¤±è´¥çš„ pattern-issue ç»„åˆ
- è‡ªåŠ¨è·³è¿‡å·²å¤±è´¥çš„ç»„åˆ
- é€‰æ‹©æ–° pattern ç»§ç»­å°è¯•

ğŸ“Š **ä»£ç é‡**ï¼š
- manager.py: ~60 è¡Œæ–°å¢ä»£ç 
- refinement.py: ~30 è¡Œæ–°å¢ä»£ç 
- ä¸¤ä¸ªæ–°æ–‡æ¡£ï¼šç”¨äºæŒ‡å¯¼å’Œè°ƒè¯•

ğŸš€ **æ•ˆæœ**ï¼š
- æ›´æ™ºèƒ½çš„ pattern é€‰æ‹©
- æ›´å¯é çš„è¿­ä»£è¿‡ç¨‹
- æ›´é«˜è´¨é‡çš„æœ€ç»ˆ story

